<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ferramentas do Produtor</title>

<style>
    :root {
        --primary: #2e8b57;
        --primary-dark: #246b44;
        --background: #f4f6f4;
        --card-bg: #fff;
    }

    body {
        margin: 0;
        background: var(--background);
        font-family: Arial, sans-serif;
    }

    header {
        background: var(--primary);
        color: white;
        padding: 20px;
        text-align: center;
    }

    header img {
        height: 80px;
        margin-bottom: 10px;
    }

    .container {
        width: 94%;
        max-width: 900px;
        margin: 20px auto;
        background: var(--card-bg);
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 0 10px #0001;
    }

    h2 { color: var(--primary); }

    button {
        width: 100%;
        background: var(--primary);
        color: white;
        padding: 16px;
        border: none;
        border-radius: 10px;
        font-size: 18px;
        margin-top: 12px;
        cursor: pointer;
    }

    button:hover { background: var(--primary-dark); }

    input {
        width: 100%;
        padding: 14px;
        margin-top: 10px;
        font-size: 18px;
        border-radius: 10px;
        border: 1px solid #bbb;
    }

    video {
        width: 100%;
        border-radius: 12px;
        margin-top: 15px;
    }

    .mensagem {
        margin-top: 15px;
        padding: 15px;
        border-radius: 10px;
        font-weight: bold;
        font-size: 16px;
    }

    .success { background: #d8ffe1; color: #1d6b34; }
    .error   { background: #ffe0e0; color: #7e0000; }

    #loading {
        display: none;
        margin-top: 15px;
        text-align: center;
        font-size: 18px;
        font-weight: bold;
        color: var(--primary-dark);
    }

    /* Telas */
    .tela { display: none; }
    .ativa { display: block; }
</style>

</head>
<body>

<header>
    <img src="logo.png">
    <h1>Ferramentas do Produtor</h1>
</header>

<!-- ‚ñë‚ñë‚ñë TELA INICIAL ‚ñë‚ñë‚ñë -->
<div id="inicio" class="container tela ativa">
    <h2>Escolha uma op√ß√£o</h2>

    <button onclick="abrirTela('foto')">üì∑ Identifica√ß√£o pela Foto</button>
    <button onclick="abrirTela('torax')">üìè Estimativa pelo T√≥rax</button>
</div>

<!-- ‚ñë‚ñë‚ñë TELA DA FOTO ‚ñë‚ñë‚ñë -->
<div id="foto" class="container tela">
    <h2>Identifica√ß√£o pela Foto</h2>

    <video id="video" playsinline autoplay></video>

    <button onclick="tirarFoto()">üì∏ Tirar Foto</button>

    <canvas id="canvas" style="display:none;"></canvas>

    <div id="loading">‚è≥ Analisando foto...</div>

    <!-- Aqui aparece somente o texto da API -->
    <div id="resultadoFoto"></div>

    <button onclick="abrirTela('inicio')">‚¨Ö Voltar</button>
</div>

<!-- ‚ñë‚ñë‚ñë TELA DO T√ìRAX ‚ñë‚ñë‚ñë -->
<div id="torax" class="container tela">
    <h2>Estimativa pelo T√≥rax</h2>

    <label>Medi√ß√£o do T√≥rax (cm):</label>
    <input id="inputTorax" type="number" placeholder="Ex: 75">

    <button onclick="calcular()">Calcular</button>

    <div id="resultadoTorax"></div>

    <button onclick="abrirTela('inicio')">‚¨Ö Voltar</button>
</div>

<script>
/* ‚ñë‚ñë‚ñë TROCAR TELAS ‚ñë‚ñë‚ñë */
function abrirTela(id) {
    document.querySelectorAll(".tela").forEach(t => t.classList.remove("ativa"));
    document.getElementById(id).classList.add("ativa");

    if (id === "foto") iniciarCamera();
}

/* ‚ñë‚ñë‚ñë C√ÇMERA ‚ñë‚ñë‚ñë */
let stream;

function iniciarCamera() {
    navigator.mediaDevices.getUserMedia({ video: true })
        .then(s => {
            stream = s;
            document.getElementById("video").srcObject = s;
        })
        .catch(() => {
            mostrarMsg("resultadoFoto", "Erro ao acessar c√¢mera.", true);
        });
}

/* ‚ñë‚ñë‚ñë TIRAR FOTO ‚Üí ENVIAR ‚Üí MOSTRAR APENAS O RESULTADO ‚ñë‚ñë‚ñë */
function tirarFoto() {
    let video = document.getElementById("video");
    let canvas = document.getElementById("canvas");
    let ctx = canvas.getContext("2d");
    let loading = document.getElementById("loading");

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    let base64full = canvas.toDataURL("image/jpeg");
    let base64clean = base64full.replace("data:image/jpeg;base64,", "");

    // Mostrar loading
    loading.style.display = "block";
    mostrarMsg("resultadoFoto", "");

    fetch("https://0h8r4swvyc.execute-api.us-east-1.amazonaws.com/prd/", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ base64: base64clean })
    })
    .then(r => r.json())
    .then(data => {
        loading.style.display = "none";

        // Exibir o que a API retornar
        mostrarMsg("resultadoFoto", data.body || "An√°lise conclu√≠da!", false);
    })
    .catch(() => {
        loading.style.display = "none";
        mostrarMsg("resultadoFoto", "Erro ao enviar a foto.", true);
    });
}

/* ‚ñë‚ñë‚ñë ESTIMATIVA PELO T√ìRAX ‚ñë‚ñë‚ñë */
function calcular() {
    let torax = parseFloat(document.getElementById("inputTorax").value);

    if (!torax || torax <= 0) {
        mostrarMsg("resultadoTorax", "Digite um valor v√°lido!", true);
        return;
    }

    let peso = (torax**3) / 10500;
    let carcaca = peso * 0.48;
    let carne = carcaca * 0.70;
    let gordura = carcaca * 0.08;

    mostrarMsg("resultadoTorax",
        `Peso estimado: <b>${peso.toFixed(1)} kg</b><br>
         Carca√ßa: <b>${carcaca.toFixed(1)} kg</b><br>
         Carne: <b>${carne.toFixed(1)} kg</b><br>
         Gordura: <b>${gordura.toFixed(1)} kg</b>`,
         false
    );
}

/* ‚ñë‚ñë‚ñë MENSAGENS ‚ñë‚ñë‚ñë */
function mostrarMsg(id, txt, erro=false) {
    let div = document.getElementById(id);
    div.className = erro ? "mensagem error" : "mensagem success";
    div.innerHTML = txt;
}
</script>

</body>
</html>
